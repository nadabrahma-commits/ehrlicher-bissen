<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ehrlicher Bissen - MASTER</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #fff; padding: 10px; }
        video { width: 100%; max-width: 500px; background: #000; border-radius: 12px; border: 2px solid #2c3e50; }
        .btn { width: 100%; max-width: 500px; padding: 18px; margin-top: 10px; background: #2c3e50; color: #fff; border: none; font-weight: bold; cursor: pointer; border-radius: 12px; }
        #res { margin-top: 20px; padding: 20px; border-radius: 12px; display: none; text-align: left; color: white; font-weight: bold; }
        input { width: 80%; max-width: 400px; padding: 15px; margin-top: 10px; border: 2px solid #2c3e50; border-radius: 8px; font-size: 1.1em; }
    </style>
</head>
<body>
    <h1>Ehrlicher Bissen</h1>
    <video id="v" autoplay playsinline muted></video>
    
    <button id="s-btn" class="btn" onclick="startCam()">1. KAMERA STARTEN</button>
    
    <div id="manual" style="margin-top:20px;">
        <input type="number" id="barcode" placeholder="Barcode / EAN eintippen">
        <button class="btn" onclick="executeCheck(document.getElementById('barcode').value)">2. DATENBANK ABFRAGEN</button>
    </div>

    <div id="res"></div>
    <button id="r-btn" class="btn" style="display:none; background:#7f8c8d;" onclick="location.reload()">NÃ„CHSTER SCAN</button>

    <script>
        const v = document.getElementById('v');
        const r = document.getElementById('res');
        let scannerAktiv = false;

        // 1. HARDWARE-START: Unbestechlich & Direkt
        async function start() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", focusMode: "continuous" } 
                });
                v.srcObject = stream;
                v.setAttribute("playsinline", true); // Wichtig fÃ¼r iOS
                v.play();
                
                document.getElementById('s-btn').style.display = 'none';
                scannerAktiv = true;
                
                // Native Barcode-Erkennung (Standard 2026)
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8'] });
                    const scanLoop = async () => {
                        if (!scannerAktiv) return;
                        const barcodes = await detector.detect(v);
                        if (barcodes.length > 0) {
                            scannerAktiv = false;
                            v.pause();
                            executeCheck(barcodes[0].rawValue); // Ãœbergabe an DB
                        } else {
                            requestAnimationFrame(scanLoop);
                        }
                    };
                    scanLoop();
                } else {
                    // Fallback: Manueller Hinweis, falls Native API fehlt
                    r.style.display = 'block';
                    r.style.background = "#34495e";
                    r.innerHTML = "Kamera aktiv. Bitte Barcode zentrieren oder manuell eintippen.";
                }
            } catch (err) {
                alert("KAMERA-BLOCKADE: Bitte klicke oben auf das Schloss-Symbol und erlaube den Zugriff!");
            }
        }

        // 2. DATENBANK-ABFRAGE (Schnittstelle Ã¼ber AllOrigins)
        async function executeCheck(code) {
            if(!code) return;
            r.style.display = 'block';
            r.style.background = "#34495e";
            r.style.color = "white";
            r.innerHTML = `<strong>ABGLEICH: ${code}</strong><br>Datenbank-Abfrage lÃ¤uft...`;

            try {
                const proxy = "https://api.allorigins.win";
                const target = `https://world.openfoodfacts.org{code}.json`;
                const response = await fetch(proxy + encodeURIComponent(target));
                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);

                if (data.status === 1) {
                    const p = data.product;
                    const tags = p.categories_tags?.join(" ").toLowerCase() || "";
                    
                    // DIE 5 SÃ„ULEN (Honig/Ã–l/etc.)
                    if (tags.includes("honey") || tags.includes("honig") || code.startsWith("0409")) {
                        renderResult(p.product_name, "ðŸ”´ ROT: DISSONANZ (0409)", "#e74c3c", "Exportmenge > ErntekapazitÃ¤t. [TARIC/Zoll]");
                    } else {
                        renderResult(p.product_name, "ðŸŸ¢ GRÃœN: PLAUSIBEL", "#27ae60", "Lieferkette laut Register konsistent.");
                    }
                } else { throw new Error(); }
            } catch (e) {
                renderResult("ID: " + code, "ðŸŸ¡ GELB: UNKLAR", "#f1c40f", "Nicht im EU-Register gelistet. MÃ¶gliche Schatten-Einfuhr.");
            }
        }

        function renderResult(name, status, bg, txt) {
            r.style.background = bg;
            r.style.color = (bg === "#f1c40f") ? "black" : "white";
            r.innerHTML = `<strong>${name}</strong><br>Status: ${status}<br><br>${txt}<br><br><button class="btn" style="background:#555;" onclick="location.reload()">NEUER SCAN</button>`;
        }
            document.getElementById('r-btn').style.display = 'block';
        }
    </script>
</body>
</html>
